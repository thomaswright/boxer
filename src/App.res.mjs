// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import SwitchJsx from "./Switch.jsx";
import * as Stdlib_Array from "rescript/lib/es6/Stdlib_Array.js";
import * as Primitive_int from "rescript/lib/es6/Primitive_int.js";
import * as Stdlib_Option from "rescript/lib/es6/Stdlib_Option.js";
import * as ReactColorful from "react-colorful";
import * as Primitive_option from "rescript/lib/es6/Primitive_option.js";
import * as JsxRuntime from "react/jsx-runtime";
import UseLocalStorageJs from "./useLocalStorage.js";

let make = SwitchJsx;

function update2D(a, i, j, f) {
  return a.map((row, rowI) => {
    if (rowI === i) {
      return row.map((cell, cellJ) => {
        if (cellJ === j) {
          return f(cell);
        } else {
          return cell;
        }
      });
    } else {
      return row;
    }
  });
}

function make2D(a, b, f) {
  return Stdlib_Array.make(a, Stdlib_Array.make(b, f()));
}

function dims2D(a) {
  let boardDimI = a.length;
  let boardDimJ = Stdlib_Option.mapOr(a[0], 0, line => line.length);
  return [
    boardDimI,
    boardDimJ
  ];
}

function check2D(a, i, j) {
  return Stdlib_Option.flatMap(a[i], row => row[j]);
}

let defaultBoard = make2D(12, 12, () => {});

let defaultBrush = make2D(3, 3, () => false);

let defaultTileMask = make2D(4, 4, () => true);

function useIsMouseDown() {
  let match = React.useState(() => false);
  let setIsMouseDown = match[1];
  React.useEffect(() => {
    let downHandler = param => setIsMouseDown(param => true);
    let upHandler = param => setIsMouseDown(param => false);
    window.addEventListener("mousedown", downHandler);
    window.addEventListener("mouseup", upHandler);
    return () => {
      window.removeEventListener("mousedown", downHandler);
      window.removeEventListener("mouseup", upHandler);
    };
  }, []);
  return match[0];
}

function getOverlayId(i, j) {
  return "canvas-overlay" + i.toString() + j.toString();
}

function App(props) {
  let match = UseLocalStorageJs("board", defaultBoard);
  let setBoard = match[1];
  let board = match[0];
  let match$1 = UseLocalStorageJs("brush", defaultBrush);
  let setBrush = match$1[1];
  let brush = match$1[0];
  let match$2 = UseLocalStorageJs("tile-mask", defaultTileMask);
  let setTileMask = match$2[1];
  let tileMask = match$2[0];
  let match$3 = UseLocalStorageJs("show-cursor-overlay", true);
  let setShowCursorOverlay = match$3[1];
  let showCursorOverlay = match$3[0];
  let match$4 = UseLocalStorageJs("my-color", "blue");
  let setMyColor = match$4[1];
  let myColor = match$4[0];
  let match$5 = React.useState(() => false);
  let setCursorOverlayOff = match$5[1];
  let cursorOverlayOff = match$5[0];
  let isMouseDown = useIsMouseDown();
  let match$6 = dims2D(board);
  let match$7 = dims2D(brush);
  let brushDimJ = match$7[1];
  let brushDimI = match$7[0];
  let match$8 = dims2D(tileMask);
  let tileMaskDimJ = match$8[1];
  let tileMaskDimI = match$8[0];
  let onMouseMove = param => setCursorOverlayOff(param => false);
  let applyOverlay = (clickI, clickJ, f) => {
    let brushCenterDimI = brushDimI / 2 | 0;
    let brushCenterDimJ = brushDimJ / 2 | 0;
    board.forEach((row, boardI) => {
      row.forEach((param, boardJ) => {
        let brushPosI = (boardI - clickI | 0) + brushCenterDimI | 0;
        let brushPosJ = (boardJ - clickJ | 0) + brushCenterDimJ | 0;
        let brushAllows = Stdlib_Option.getOr(check2D(brush, brushPosI, brushPosJ), false);
        let maskAllows = Stdlib_Option.getOr(check2D(tileMask, Primitive_int.mod_(boardI, tileMaskDimI), Primitive_int.mod_(boardJ, tileMaskDimJ)), false);
        if (!(brushAllows && maskAllows)) {
          return;
        }
        let id = getOverlayId(boardI, boardJ);
        Stdlib_Option.mapOr(Primitive_option.fromNullable(document.getElementById(id)), undefined, f);
      });
    });
  };
  let applyBrush = (clickI, clickJ) => {
    let brushCenterDimI = brushDimI / 2 | 0;
    let brushCenterDimJ = brushDimJ / 2 | 0;
    setBoard(b => b.map((row, boardI) => row.map((cell, boardJ) => {
      let brushPosI = (boardI - clickI | 0) + brushCenterDimI | 0;
      let brushPosJ = (boardJ - clickJ | 0) + brushCenterDimJ | 0;
      let brushAllows = Stdlib_Option.getOr(check2D(brush, brushPosI, brushPosJ), false);
      let maskAllows = Stdlib_Option.getOr(check2D(tileMask, Primitive_int.mod_(boardI, tileMaskDimI), Primitive_int.mod_(boardJ, tileMaskDimJ)), false);
      if (brushAllows && maskAllows) {
        return myColor;
      } else {
        return cell;
      }
    })));
  };
  React.useEffect(() => {
    window.addEventListener("mousemove", onMouseMove);
  }, []);
  return JsxRuntime.jsxs("div", {
    children: [
      JsxRuntime.jsxs("div", {
        children: [
          JsxRuntime.jsx("div", {
            children: tileMask.map((line, i) => line.map((cell, j) => JsxRuntime.jsxs("div", {
              children: [
                JsxRuntime.jsx("div", {
                  className: "w-full h-full absolute",
                  style: {
                    backgroundColor: cell ? "#ffa700" : "transparent"
                  }
                }),
                cursorOverlayOff || !showCursorOverlay ? null : JsxRuntime.jsx("div", {
                    className: "absolute w-full h-full inset-0 bg-black opacity-0 group-hover:opacity-20"
                  })
              ],
              className: "w-full h-full group relative ",
              onClick: param => {
                setTileMask(b => update2D(b, i, j, v => !v));
                setCursorOverlayOff(param => true);
              },
              onMouseEnter: param => {
                if (isMouseDown) {
                  return setTileMask(b => update2D(b, i, j, v => !v));
                }
                
              }
            }, i.toString() + j.toString()))),
            className: "border w-fit h-fit",
            style: {
              display: "grid",
              gridTemplateColumns: "repeat(" + tileMaskDimI.toString() + ", 1rem)",
              gridTemplateRows: "repeat(" + tileMaskDimJ.toString() + ", 1rem)"
            }
          }),
          JsxRuntime.jsx("div", {
            children: brush.map((line, i) => line.map((cell, j) => {
              let isCursorCenter = (brushDimI / 2 | 0) === i && (brushDimJ / 2 | 0) === j;
              return JsxRuntime.jsxs("div", {
                children: [
                  JsxRuntime.jsx("div", {
                    className: "w-full h-full absolute",
                    style: {
                      backgroundColor: cell ? "#00c3ff" : "transparent"
                    }
                  }),
                  cursorOverlayOff || !showCursorOverlay ? null : JsxRuntime.jsx("div", {
                      className: "absolute w-full h-full inset-0 bg-black opacity-0 group-hover:opacity-20"
                    }),
                  isCursorCenter ? JsxRuntime.jsx("div", {
                      children: JsxRuntime.jsx("div", {
                        className: " w-1/2 h-1/2 bg-red-500 rounded-full"
                      }),
                      className: "absolute w-full h-full flex flex-row items-center justify-center "
                    }) : null
                ],
                className: "w-full h-full group relative ",
                onClick: param => {
                  setBrush(b => update2D(b, i, j, v => !v));
                  setCursorOverlayOff(param => true);
                },
                onMouseEnter: param => {
                  if (isMouseDown) {
                    return setBrush(b => update2D(b, i, j, v => !v));
                  }
                  
                }
              }, i.toString() + j.toString());
            })),
            className: "border w-fit h-fit",
            style: {
              display: "grid",
              gridTemplateColumns: "repeat(" + brushDimI.toString() + ", 1rem)",
              gridTemplateRows: "repeat(" + brushDimJ.toString() + ", 1rem)"
            }
          })
        ]
      }),
      JsxRuntime.jsx("div", {
        children: board.map((line, i) => line.map((cell, j) => {
          let backgroundColor = Stdlib_Option.getOr(cell, "transparent");
          return JsxRuntime.jsxs("div", {
            children: [
              JsxRuntime.jsx("div", {
                className: "w-full h-full absolute",
                style: {
                  backgroundColor: backgroundColor
                }
              }),
              cursorOverlayOff || !showCursorOverlay ? null : JsxRuntime.jsx("div", {
                  className: "absolute w-full h-full inset-0 bg-black opacity-20",
                  id: getOverlayId(i, j),
                  style: {
                    display: "none"
                  }
                })
            ],
            className: "w-full h-full group relative",
            onClick: param => {
              applyBrush(i, j);
              setCursorOverlayOff(param => true);
            },
            onMouseEnter: param => {
              applyOverlay(i, j, el => {
                el.style.display = "block";
              });
              if (isMouseDown) {
                return applyBrush(i, j);
              }
              
            },
            onMouseLeave: param => applyOverlay(i, j, el => {
              el.style.display = "none";
            })
          }, i.toString() + j.toString());
        })),
        className: "border w-fit h-fit",
        style: {
          display: "grid",
          gridTemplateColumns: "repeat(" + match$6[0].toString() + ", 1rem)",
          gridTemplateRows: "repeat(" + match$6[1].toString() + ", 1rem)"
        }
      }),
      JsxRuntime.jsxs("div", {
        children: [
          JsxRuntime.jsx(ReactColorful.HexColorPicker, {
            color: myColor,
            onChange: newColor => setMyColor(param => newColor)
          }),
          JsxRuntime.jsxs("div", {
            children: [
              JsxRuntime.jsx("div", {
                children: "Show Brush Overlay",
                className: "flex flex-row"
              }),
              JsxRuntime.jsx(make, {
                checked: showCursorOverlay,
                onChange: v => setShowCursorOverlay(param => v)
              })
            ]
          })
        ],
        className: "flex flex-col gap-5"
      })
    ],
    className: " flex flex-row gap-5"
  });
}

let make$1 = App;

export {
  make$1 as make,
}
/* make Not a pure module */
